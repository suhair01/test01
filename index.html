<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RubyRouter AVAX↔Token</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>RubyRouter AVAX Swap</h2>

  <label>Swap Direction:</label><br />
  <select id="direction">
    <option value="avaxToToken">AVAX → Token</option>
    <option value="tokenToAvax">Token → AVAX</option>
  </select><br /><br />

  <label>Token Address:</label><br />
  <input id="token" placeholder="0x..." size="45"/><br />

  <label>Amount:</label><br />
  <input id="amount" placeholder="Enter raw amount (wei)" /><br />

  <label>Min Amount Out:</label><br />
  <input id="amountOutMin" placeholder="Slippage protection" /><br />

  <button onclick="swap()">Swap</button>
  <p id="status"></p>

  <script>
    const routerAddress = "0xB114312a34b55183034cBf8F56A6E89c3a03E544"; // RubyRouter
    const wavaxAddress = "0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7"; // WAVAX

    const erc20Abi = [
      "function approve(address spender, uint256 amount) external returns (bool)",
      "function allowance(address owner, address spender) external view returns (uint256)"
    ];

    const routerAbi = [
      "function swapExactAVAXForTokensSupportingFeeOnTransferTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable",
      "function swapExactTokensForAVAXSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external"
    ];

    async function swap() {
      const status = document.getElementById("status");
      try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const user = await signer.getAddress();

        const direction = document.getElementById("direction").value;
        const token = document.getElementById("token").value;
        const amount = document.getElementById("amount").value;
        const amountOutMin = document.getElementById("amountOutMin").value;
        const deadline = Math.floor(Date.now() / 1000) + 1800;

        const router = new ethers.Contract(routerAddress, routerAbi, signer);

        if (direction === "avaxToToken") {
          const path = [wavaxAddress, token];
          const tx = await router.swapExactAVAXForTokensSupportingFeeOnTransferTokens(
            amountOutMin,
            path,
            user,
            deadline,
            { value: amount }
          );
          status.innerText = "Swapping AVAX for Token...";
          await tx.wait();
          status.innerText = "Swap complete!";
        } else {
          const path = [token, wavaxAddress];
          const tokenContract = new ethers.Contract(token, erc20Abi, signer);

          const allowance = await tokenContract.allowance(user, routerAddress);
          if (BigInt(allowance) < BigInt(amount)) {
            const approveTx = await tokenContract.approve(routerAddress, amount);
            status.innerText = "Approving token...";
            await approveTx.wait();
          }

          const tx = await router.swapExactTokensForAVAXSupportingFeeOnTransferTokens(
            amount,
            amountOutMin,
            path,
            user,
            deadline
          );
          status.innerText = "Swapping Token for AVAX...";
          await tx.wait();
          status.innerText = "Swap complete!";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Error: " + err.message;
      }
    }
  </script>
</body>
</html>
