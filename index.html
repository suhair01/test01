<!DOCTYPE html>
<html>
<head><title>RubySwap Debug</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<h3>RubySwap Debug</h3>
<button onclick="connect()">Connect</button><br>
<input id="amt" placeholder="AVAX amt"><button onclick="test()">Debug Swap</button>
<pre id="log"></pre>

<script>
  const arena = "0xF56D524D651B90E4B84dc2FffD83079698b9066E";
  const ruby = "0xd76ac5eee795876f07d89665bf28f0826aa68fd2";
  const WAVAX = "0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7";
  const USDC = "0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E";
  let p, s, you, aC, rC;

  async function connect(){
    if (!window.ethereum) return log("‚ùå No MetaMask");
    try {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      p = new ethers.BrowserProvider(window.ethereum);
      s = await p.getSigner();
      you = await s.getAddress();
      aC = new ethers.Contract(arena, ["function getAmountsOut(uint,address[]) view returns(uint[])"], p);
      rC = new ethers.Contract(ruby, ["function swapExactAVAXForTokensSupportingFeeOnTransferTokens(uint,address[],address,uint) payable"], s);
      log("‚úÖ Connected: " + you);
    } catch(e){ log("Err connect: " + e); }
  }

  async function test(){
    const v = document.getElementById("amt").value;
    try {
      const ai = ethers.parseUnits(v,18);
      log("AmountIn: " + ai);

      const out = await aC.getAmountsOut(ai, [WAVAX,USDC]);
      log("‚úÖ getAmountsOut: " + out);

      const min = out[1] * BigInt(98) / BigInt(100); // 2% slippage
      log("minOut: " + min);
      
      const tx = await rC.swapExactAVAXForTokensSupportingFeeOnTransferTokens(min, [WAVAX,USDC], you, Math.floor(Date.now()/1e3)+300, { value: ai });
      log("TX Sent: " + tx.hash);
      await tx.wait();
      log("üéâ Swap Mined");
    } catch(e){
      log("üí• Error: " + (e.error?.message || e.reason || e.message || e));
      console.error(e);
    }
  }

  function log(m){ document.getElementById("log").innerText += m + "\n" }
</script>
</body>
</html>
