<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arena DEX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
  <style>
    body { background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
    .container { max-width: 440px; margin: 40px auto; background: #1f1f1f; padding: 24px; border-radius: 16px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    .token-box { background: #2a2a2a; padding: 16px; border-radius: 12px; margin-bottom: 16px; position: relative; }
    label { font-size: 14px; }
    input, select { width: 100%; padding: 10px; margin-top: 6px; background: #333; color: white; border: none; border-radius: 8px; font-size: 16px; }
    .btn { background-color: #00c2ff; color: white; padding: 12px; width: 100%; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; margin-top: 16px; }
    .info { margin-top: 8px; font-size: 14px; color: #ccc; }
    .reverse-btn { background: #444; margin: 8px auto; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 20px; }
    .max-btn { position: absolute; top: 34px; right: 10px; background: #00c2ff; border: none; padding: 4px 10px; border-radius: 8px; color: white; cursor: pointer; font-size: 12px; }
  </style>
</head>
<body>
<div class="container">
  <h2>ðŸŒ€ Arena DEX</h2>
  <div class="token-box">
    <label>From Token:</label>
    <select id="tokenInSelect"></select>
    <div class="info" id="balanceIn">Balance: -</div>
    <input id="tokenInAmount" placeholder="Enter amount" />
    <button class="max-btn" onclick="setMax()">MAX</button>
  </div>

  <div class="reverse-btn" onclick="reverseTokens()">â‡…</div>

  <div class="token-box">
    <label>To Token:</label>
    <select id="tokenOutSelect"></select>
    <div class="info" id="balanceOut">Balance: -</div>
  </div>

  <button class="btn" onclick="connect()">Connect Wallet</button>
  <p class="info" id="walletStatus">Not connected</p>
  <button class="btn" onclick="swap()">Swap</button>
</div>

<script>
const factoryAddress = "0xF16784dcAf838a3e16bEF7711a62D12413c39BD1";
const FACTORY_ABI = [
  "function allPairsLength() view returns (uint)",
  "function allPairs(uint) view returns (address)"
];
const PAIR_ABI = [
  "function token0() view returns (address)",
  "function token1() view returns (address)"
];
const ERC20_ABI = [
  "function symbol() view returns (string)",
  "function name() view returns (string)",
  "function decimals() view returns (uint8)"
];

let provider, signer, userAddress, tokenMap = {};

async function connect() {
  if (!window.ethereum) return alert("Install MetaMask");
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  userAddress = await signer.getAddress();
  document.getElementById("walletStatus").innerText = `Connected: ${userAddress}`;
  await loadTokensFromArenaFactory();
}

async function getTokenInfo(ca) {
  try {
    const token = new ethers.Contract(ca, ERC20_ABI, provider);
    const [symbol, name, decimals] = await Promise.all([
      token.symbol(),
      token.name(),
      token.decimals()
    ]);
    return { symbol, name, decimals, address: ca };
  } catch (e) {
    console.log("Invalid token:", ca);
    return null;
  }
}

async function loadTokensFromArenaFactory() {
  const factory = new ethers.Contract(factoryAddress, FACTORY_ABI, provider);
  const total = await factory.allPairsLength();
  const tokens = new Set();

  for (let i = 0; i < Math.min(total, 50); i++) {
    try {
      const pairAddr = await factory.allPairs(i);
      const pair = new ethers.Contract(pairAddr, PAIR_ABI, provider);
      const [token0, token1] = await Promise.all([
        pair.token0(),
        pair.token1()
      ]);
      tokens.add(token0);
      tokens.add(token1);
    } catch (err) {
      console.log("Error fetching pair:", err);
    }
  }

  const inSel = document.getElementById("tokenInSelect");
  const outSel = document.getElementById("tokenOutSelect");
  inSel.innerHTML = '';
  outSel.innerHTML = '';

  for (const addr of tokens) {
    const info = await getTokenInfo(addr);
    if (!info) continue;
    tokenMap[addr] = info;
    const option = new Option(`${info.symbol} (${info.name})`, addr);
    inSel.appendChild(option.cloneNode(true));
    outSel.appendChild(option.cloneNode(true));
  }
}

function reverseTokens() {
  const inSel = document.getElementById("tokenInSelect");
  const outSel = document.getElementById("tokenOutSelect");
  const tmp = inSel.value;
  inSel.value = outSel.value;
  outSel.value = tmp;
}

function setMax() {
  // Placeholder for balance check
}

function swap() {
  alert("Swap logic here");
}
</script>
</body>
</html>

